# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EusxNQiWc-eiZ7oA3MAitjZGS1m-W3Uw
"""
import streamlit as st
import geopandas as gpd
import pandas as pd
import base64
from engine_layer_py import run_analysis, calculate_priority_recommendations

# --- 1. BACKGROUND CONFIGURATION ---
def get_base64_of_bin_file(bin_file):
    with open(bin_file, 'rb') as f:
        data = f.read()
    return base64.b64encode(data).decode()

def get_base64_of_bin_file(bin_file):
    with open(bin_file, 'rb') as f:
        data = f.read()
    return base64.b64encode(data).decode()

def set_rotated_page_bg(bin_file):
    try:
        bin_str = get_base64_of_bin_file(bin_file)
        # The CSS below handles the base64 background AND ensures the clouds are "up"
        # by using background-position: top center and fixed attachment.
        page_bg_img = f'''
        <style>
        .stApp {{
            background-image: url("data:image/png;base64,{bin_str}");
            background-size: cover;
            background-position: top center; 
            background-attachment: fixed;
            background-repeat: no-repeat;
        }}
        /* Overlay to make the content readable over the background */
        .main {{
            background-color: rgba(255, 255, 255, 0.85); 
            padding: 2rem;
            border-radius: 10px;
            margin: 20px;
        }}
        </style>
        '''
        st.markdown(page_bg_img, unsafe_allow_html=True)
    except FileNotFoundError:
        st.warning("Background image 'background.png' not found. Please ensure it is in your GitHub repository.")

# Execute the background setup
set_rotated_page_bg('background.png')

# --- 2. INTERFACE ---
st.title("KADUNA STATE HEALTH FACILITY DECISION SUPPORT SYSTEM")

st.sidebar.header("Upload Input Data")
outpatient_files = st.sidebar.file_uploader("Outpatient Dataset", type=['xlsx', 'xls'], accept_multiple_files=True)
health_facilities = st.sidebar.file_uploader("Health Facilities (Zip)", type=['zip'])
lga_boundary = st.sidebar.file_uploader("Administrative Boundaries (Zip)", type=['zip'])
roads = st.sidebar.file_uploader("Road Network (Geopackage)", type=['gpkg'])
pop_raster = st.sidebar.file_uploader("Population Data (TIF)", type=['tif'])

# --- 3. THE TRIGGER ---
if st.sidebar.button("Run Full System Analysis"):
    # FIX: Check if files exist before processing
    if outpatient_files and health_facilities and lga_boundary and roads and pop_raster:
        with st.spinner("Processing spatial data..."):
            # DEFINING THE VARIABLES LOCALLY
            facilities_gdf = gpd.read_file(health_facilities)
            lga_gdf = gpd.read_file(lga_boundary)
            roads_gdf = gpd.read_file(roads)

            # Now variables are defined, we can call the engine
            outputs = run_analysis(
                facilities_gdf, 
                roads_gdf, 
                lga_gdf, 
                outpatient_files, 
                pop_raster
            )

            if outputs[0] is not None:
                healthcare_deserts, results = outputs
                priority_df, sites = calculate_priority_recommendations(lga_gdf, healthcare_deserts)

                # --- OUTPUT DASHBOARD ---
                st.header("Strategic Resource Allocation")
                col1, col2 = st.columns([2, 1])
                with col1:
                    st.subheader("I. LGA Priority Ranking")
                    st.dataframe(priority_df, use_container_width=True)
                with col2:
                    st.subheader("II. Suggested GPS Locations")
                    st.table(pd.DataFrame(sites))
    else:
        st.sidebar.error("⚠️ Please upload all required files first.")
