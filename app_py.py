# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EusxNQiWc-eiZ7oA3MAitjZGS1m-W3Uw
"""
import streamlit as st
import geopandas as gpd
import matplotlib.pyplot as plt
import seaborn as sns
from engine_layer_py import run_analysis

# 1. Page Config & Persistence
st.set_page_config(layout="wide")
if 'analysis_results' not in st.session_state:
    st.session_state['analysis_results'] = None

st.title("KADUNA HEALTH ANALYTICS")

# 2. Sidebar Uploads
with st.sidebar:
    out_f = st.file_uploader("Outpatient Files", accept_multiple_files=True)
    fac_f = st.file_uploader("Facilities (Zip)", type=['zip'])
    lga_f = st.file_uploader("Boundaries (Zip)", type=['zip'])
    
    if st.button("Run Full Analysis"):
        if out_f and fac_f and lga_f:
            with st.spinner("Processing..."):
                res, msg = run_analysis(gpd.read_file(fac_f), None, gpd.read_file(lga_f), out_f)
                st.session_state['analysis_results'] = res
                st.session_state['msg'] = msg
        else:
            st.error("Please upload all files first.")

# 3. Persistent Output Rendering
if st.session_state['analysis_results'] is not None:
    spatial_data = st.session_state['analysis_results']
    st.success(st.session_state['msg'])

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("I. Heatmap")
        fig, ax = plt.subplots()
        spatial_data.plot(column='Total_Outpatient', cmap='OrRd', legend=True, ax=ax)
        st.pyplot(fig)

    with col2:
        st.subheader("II. LGA Trends")
        long_data = st.session_state['long_data']
        lga = st.selectbox("Choose LGA", sorted(long_data['LGA'].unique()))
        fig2, ax2 = plt.subplots()
        sns.lineplot(data=long_data[long_data['LGA']==lga], x='Year', y='Count', marker='o', ax=ax2)
        st.pyplot(fig2)

    st.subheader("III. Hotspot Statistics")
    st.metric("Global Moran's I", round(st.session_state['moran_result'].I, 3))
