# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EusxNQiWc-eiZ7oA3MAitjZGS1m-W3Uw
"""
import streamlit as st
import geopandas as gpd
import pandas as pd
import base64
import matplotlib.pyplot as plt
import seaborn as sns
from engine_layer_py import run_analysis

# Background Fix
def set_bg(bin_file):
    with open(bin_file, 'rb') as f:
        bin_str = base64.b64encode(f.read()).decode()
    st.markdown(f'''<style>.stApp {{background-image: url("data:image/png;base64,{bin_str}"); background-size: cover; background-position: top center; background-attachment: fixed;}} .main {{background-color: rgba(255, 255, 255, 0.85); padding: 2rem; border-radius: 10px;}}</style>''', unsafe_allow_html=True)

set_bg('background.png')

st.title("KADUNA HEALTH DSS")

# Sidebar Uploads
outpatient_files = st.sidebar.file_uploader("Outpatient Data", accept_multiple_files=True)
health_facilities = st.sidebar.file_uploader("Facilities (Zip)", type=['zip'])
lga_boundary = st.sidebar.file_uploader("Boundaries (Zip)", type=['zip'])
roads = st.sidebar.file_uploader("Roads (gpkg)", type=['gpkg'])
pop_raster = st.sidebar.file_uploader("Population (tif)", type=['tif'])

if st.sidebar.button("Run Full System Analysis"):
    if all([outpatient_files, health_facilities, lga_boundary, roads, pop_raster]):
        f_gdf = gpd.read_file(health_facilities)
        l_gdf = gpd.read_file(lga_boundary)
        r_gdf = gpd.read_file(roads)
        
        deserts, spatial_data, msg = run_analysis(f_gdf, r_gdf, l_gdf, outpatient_files, pop_raster)
        
        if spatial_data is not None:
            # 1. Heatmap
            st.header("I. Outpatient Distribution Heatmap")
            fig, ax = plt.subplots()
            spatial_data.plot(column='Total_Outpatient', cmap='OrRd', legend=True, ax=ax)
            st.pyplot(fig)

            # 2. Trend
            st.header("II. LGA Trend Analysis")
            long_data = st.session_state['long_data']
            lga = st.selectbox("Select LGA", long_data['LGA'].unique())
            fig2, ax2 = plt.subplots()
            sns.lineplot(data=long_data[long_data['LGA']==lga], x='Year', y='Count', ax=ax2)
            st.pyplot(fig2)

            # 3. Moran's I
            st.header("III. Spatial Hotspots")
            st.metric("Global Moran's I Index", round(st.session_state['moran_result'].I, 3))
    else:
        st.error("Please upload all files.")
