# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EusxNQiWc-eiZ7oA3MAitjZGS1m-W3Uw
"""
import streamlit as st
import geopandas as gpd
import pandas as pd
# Use the correct file name for import
from engine_layer_py import run_analysis, calculate_priority_recommendations

st.title("Kaduna Health Decision Support System")

# Sidebar for all inputs
st.sidebar.header("Upload Input Data")
outpatient_file = st.sidebar.file_uploader("Outpatient Excel", type=['xlsx'])
health_facilities = st.sidebar.file_uploader("Health Facilities (Zip)", type=['zip'])
lga_boundary = st.sidebar.file_uploader("LGA Boundaries (Zip)", type=['zip'])
roads = st.sidebar.file_uploader("Road Network (Geopackage)", type=['gpkg'])

if st.sidebar.button("Run Full Analysis"):
    if outpatient_file and health_facilities and lga_boundary and roads:
        # Load the files
        facilities_gdf = gpd.read_file(health_facilities)
        lga_gdf = gpd.read_file(lga_boundary)
        roads_gdf = gpd.read_file(roads)
        
        # 1. Run engine to get deserts
        deserts, status = run_analysis(facilities_gdf, roads_gdf, outpatient_file)
        
        # 2. Run recommendations using the output from step 1
        priority_df, sites = calculate_priority_recommendations(lga_gdf, deserts)
        
        st.header("Strategic Resource Allocation")
        st.dataframe(priority_df)
        st.subheader("Proposed GPS Locations")
        st.table(pd.DataFrame(sites))
    else:
        st.error("Please upload all required files.")
