# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EusxNQiWc-eiZ7oA3MAitjZGS1m-W3Uw
"""

import streamlit as st
import geopandas as gpd
import matplotlib.pyplot as plt
import seaborn as sns
import pandas as pd
from engine_layer_py import run_analysis

st.set_page_config(layout="wide", page_title="Kaduna Health Intelligence")

# 1. Dashboard Title & Context
st.title("ğŸ¥ KADUNA STATE STRATEGIC HEALTH INTELLIGENCE")
st.markdown("---")

# 2. Sidebar Uploads
with st.sidebar:
    st.header("Strategic Inputs")
    outs = st.file_uploader("Outpatient Data", accept_multiple_files=True)
    facs = st.file_uploader("Facilities (Zip)", type=['zip'])
    lgas = st.file_uploader("Boundaries (Zip)", type=['zip'])
    roads = st.file_uploader("Roads (gpkg)", type=['gpkg'])
    pops = st.file_uploader("Population (tif)", type=['tif'])
    process = st.button("Generate Stakeholder Report")

if process and all([outs, facs, lgas, roads, pops]):
    annual_maps, deserts, underserved, long_data, mi = run_analysis(
        gpd.read_file(facs), gpd.read_file(roads), gpd.read_file(lgas), outs, pops
    )

    if annual_maps:
        # --- TAB 1: TEMPORAL DISTRIBUTION ---
        st.header("I. Annual Outpatient Distribution (Rate per 10k)")
        years = list(annual_maps.keys())
        cols = st.columns(len(years))
        for i, yr in enumerate(years):
            with cols[i]:
                st.subheader(f"Year {yr}")
                fig, ax = plt.subplots()
                annual_maps[yr].plot(column='Rate_Per_10k', cmap='YlOrRd', legend=True, ax=ax)
                ax.set_axis_off()
                st.pyplot(fig)

        # --- TAB 2: HEALTHCARE DESERTS ---
        st.header("II. Healthcare Deserts & Underserved LGAs")
        c1, c2 = st.columns([2, 1])
        with c1:
            st.write("Red areas indicate locations >60 minutes from a facility.")
            fig_d, ax_d = plt.subplots()
            annual_maps[max(years)].boundary.plot(ax=ax_d, color='black', linewidth=0.5)
            deserts.to_crs(annual_maps[max(years)].crs).plot(ax=ax_d, color='red', alpha=0.7)
            st.pyplot(fig_d)
        with c2:
            st.info("**Priority List: Underserved LGAs**")
            st.table(pd.DataFrame(underserved, columns=["LGA Name"]))

        # --- TAB 3: SEASONALITY ---
        st.header("III. Seasonal Demand Analysis")
        fig_s, ax_s = plt.subplots(figsize=(10, 4))
        sns.boxplot(data=long_data, x='Season', y='Count', palette='Set2', ax=ax_s)
        st.pyplot(fig_s)

        # --- TAB 4: MORAN'S I ---
        st.header("IV. Spatial Inequality (Moran's I)")
        m1, m2 = st.columns(2)
        m1.metric("Moran's I Index", round(mi.I, 4))
        m1.metric("P-Value", round(mi.p_sim, 4))
        
        with m2:
            conclusion = "Clustered (Inequitable)" if mi.I > 0 and mi.p_sim < 0.05 else "Random"
            st.subheader(f"Status: {conclusion}")
            st.write("**Stakeholder Implication:** Significant clustering means healthcare access is location-dependent. Policies must target 'Cold Spot' LGAs to reduce the state-wide inequality gap.")
