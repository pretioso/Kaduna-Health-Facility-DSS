# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EusxNQiWc-eiZ7oA3MAitjZGS1m-W3Uw
"""

import streamlit as st
import geopandas as gpd
import pandas as pd
import base64
import matplotlib.pyplot as plt
import seaborn as sns
from engine_layer_py import run_analysis

# --- BACKGROUND & CSS ---
def set_bg(bin_file):
    with open(bin_file, 'rb') as f:
        bin_str = base64.b64encode(f.read()).decode()
    st.markdown(f'''
        <style>
        .stApp {{
            background-image: url("data:image/png;base64,{bin_str}");
            background-size: cover;
            background-position: top center; /* Clouds at top */
            background-attachment: fixed;
        }}
        .main {{ background-color: rgba(255, 255, 255, 0.9); padding: 2rem; border-radius: 15px; }}
        </style>
    ''', unsafe_allow_html=True)

try: set_bg('background.png')
except: pass

st.title("KADUNA HEALTH FACILITY DSS")

# --- SIDEBAR UPLOADS ---
with st.sidebar:
    st.header("1. Upload Data")
    out_files = st.file_uploader("Outpatient Excel(s)", accept_multiple_files=True)
    fac_file = st.file_uploader("Facilities (Zip)", type=['zip'])
    lga_file = st.file_uploader("Boundaries (Zip)", type=['zip'])
    road_file = st.file_uploader("Road Network (gpkg)", type=['gpkg'])
    pop_file = st.file_uploader("Population (tif)", type=['tif'])
    
    analyze = st.button("Run Full Analysis")

# --- EXECUTION & PERSISTENCE ---
if analyze:
    if all([out_files, fac_file, lga_file, road_file, pop_file]):
        with st.spinner("Processing Roads, Population, and Spatial Patterns..."):
            res = run_analysis(gpd.read_file(fac_file), gpd.read_file(road_file), gpd.read_file(lga_file), out_files, pop_file)
            st.session_state['main_results'] = res
    else:
        st.sidebar.error("Please upload all 5 files.")

# --- RENDERING OUTPUTS ---
if 'main_results' in st.session_state and st.session_state['main_results'][0] is not None:
    deserts, spatial_data, msg = st.session_state['main_results']
    
    st.success(msg)
    
    col1, col2 = st.columns(2)
    with col1:
        st.header("I. Attendance Heatmap")
        fig, ax = plt.subplots()
        spatial_data.plot(column='Rate', cmap='YlOrRd', legend=True, ax=ax)
        st.pyplot(fig)

    with col2:
        st.header("II. Healthcare Deserts")
        fig2, ax2 = plt.subplots()
        spatial_data.boundary.plot(ax=ax2, color='black', linewidth=0.5)
        deserts.plot(ax=ax2, color='red', alpha=0.7)
        st.pyplot(fig2)

    st.header("III. Spatial Clustering (Moran's I)")
    st.metric("Global Moran's I", round(st.session_state['moran'].I, 4))
