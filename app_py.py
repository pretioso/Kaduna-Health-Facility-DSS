# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EusxNQiWc-eiZ7oA3MAitjZGS1m-W3Uw
"""
import streamlit as st
import geopandas as gpd
import pandas as pd
# Import the engine logic from your other file
from engine_layer_py import run_analysis, calculate_priority_recommendations

st.set_page_config(page_title="Kaduna Health DSS", layout="wide")
st.title("Kaduna Health Decision Support System")

# --- PHASE 1: INPUT LAYER ---
st.sidebar.header("1. Upload Input Data")
outpatient_file = st.sidebar.file_uploader("Outpatient Excel", type=['xlsx'])
health_facilities_file = st.sidebar.file_uploader("Health Facilities (Zip)", type=['zip'])
lga_boundary_file = st.sidebar.file_uploader("LGA Boundaries (Zip)", type=['zip'])
roads_file = st.sidebar.file_uploader("Road Network (Geopackage)", type=['gpkg'])

# --- PHASE 2: ENGINE TRIGGER ---
if st.sidebar.button("Run Full System Analysis"):
    if outpatient_file and health_facilities_file and lga_boundary_file and roads_file:
        # Load data into GeoDataFrames
        facilities = gpd.read_file(health_facilities_file)
        lga_bounds = gpd.read_file(lga_boundary_file)
        roads = gpd.read_file(roads_file)

        st.write("Processing Spatial Data... Please wait.")
        
        # 1. Run main analysis to generate the healthcare_deserts object
        # Note: Ensure your run_analysis function returns (healthcare_deserts, results)
        healthcare_deserts, results = run_analysis(facilities, roads, outpatient_file)

        # 2. Generate priority recommendations using the deserts created above
        priority_df, sites = calculate_priority_recommendations(lga_bounds, healthcare_deserts)

        # --- PHASE 3: OUTPUT DASHBOARD ---
        st.header("üìç Strategic Resource Allocation")
        
        col1, col2 = st.columns(2)
        with col1:
            st.subheader("I. LGA Priority Ranking")
            st.dataframe(priority_df, use_container_width=True)

        with col2:
            st.subheader("II. Suggested GPS Locations (30km Spacing)")
            st.table(pd.DataFrame(sites))
            
    else:
        st.error("Please upload all four required files in the sidebar.")
