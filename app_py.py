# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EusxNQiWc-eiZ7oA3MAitjZGS1m-W3Uw
"""
import streamlit as st
import geopandas as gpd
import pandas as pd
import base64
import matplotlib.pyplot as plt
import seaborn as sns
from engine_layer_py import run_analysis

# Background orientation fix
def set_bg(bin_file):
    try:
        with open(bin_file, 'rb') as f:
            bin_str = base64.b64encode(f.read()).decode()
        st.markdown(f'''
            <style>
            .stApp {{
                background-image: url("data:image/png;base64,{bin_str}");
                background-size: cover;
                background-position: top center;
                background-attachment: fixed;
            }}
            .main {{
                background-color: rgba(255, 255, 255, 0.9);
                padding: 2rem;
                border-radius: 12px;
            }}
            </style>
            ''', unsafe_allow_html=True)
    except: pass

set_bg('background.png')

st.title("KADUNA STATE HEALTH FACILITY DSS")

# Sidebar
st.sidebar.header("Upload Files")
outpatient_files = st.sidebar.file_uploader("Outpatient Data", accept_multiple_files=True)
health_facilities = st.sidebar.file_uploader("Facilities (Zip/Shp)", type=['zip', 'shp'])
lga_boundary = st.sidebar.file_uploader("Boundaries (Zip/Shp)", type=['zip', 'shp'])
roads = st.sidebar.file_uploader("Road Network (gpkg)", type=['gpkg'])
pop_raster = st.sidebar.file_uploader("Population (tif)", type=['tif'])

if st.sidebar.button("Run Full System Analysis"):
    if all([outpatient_files, health_facilities, lga_boundary, roads, pop_raster]):
        f_gdf = gpd.read_file(health_facilities)
        l_gdf = gpd.read_file(lga_boundary)
        r_gdf = gpd.read_file(roads)
        
        deserts, spatial_data, msg = run_analysis(f_gdf, r_gdf, l_gdf, outpatient_files, pop_raster)
        
        if spatial_data is not None:
            st.success(msg)
            
            # --- TANGIBLE OUTPUT 1: HEATMAP ---
            st.header("I. Outpatient Distribution Heatmap")
            fig, ax = plt.subplots(figsize=(10, 6))
            spatial_data.plot(column='Total_Outpatient', cmap='YlOrRd', legend=True, ax=ax)
            ax.set_title("Heatmap of Outpatient Frequency (Latest Year)")
            st.pyplot(fig)

            # --- TANGIBLE OUTPUT 2: TRENDS ---
            st.header("II. LGA Temporal Trends")
            long_data = st.session_state['long_data']
            lga_list = sorted(long_data['LGA'].unique())
            selected_lga = st.selectbox("Select LGA for Trend Analysis", lga_list)
            
            fig2, ax2 = plt.subplots(figsize=(10, 4))
            lga_df = long_data[long_data['LGA'] == selected_lga]
            sns.lineplot(data=lga_df, x='Year', y='Count', marker='o', ax=ax2)
            st.pyplot(fig2)

            # --- TANGIBLE OUTPUT 3: MORAN'S I ---
            st.header("III. Spatial Clustering (Hotspots)")
            moran_val = st.session_state['moran_result'].I
            st.metric("Global Moran's I Index", round(moran_val, 4), 
                      help=">0 indicates clustering (Hotspots), <0 indicates dispersion.")
    else:
        st.error("Missing files in sidebar. Please upload all 5 datasets.")
