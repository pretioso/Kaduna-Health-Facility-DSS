# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EusxNQiWc-eiZ7oA3MAitjZGS1m-W3Uw
"""
import streamlit as st
import geopandas as gpd
import pandas as pd
import base64
# Import the engine logic from your other file
from engine_layer_py import run_analysis, calculate_priority_recommendations

# --- 1. BACKGROUND IMAGE CONFIGURATION ---
def get_base64_of_bin_file(bin_file):
    with open(bin_file, 'rb') as f:
        data = f.read()
    return base64.b64encode(data).decode()

def set_png_as_page_bg(bin_file):
    bin_str = get_base64_of_bin_file(bin_file)
    page_bg_img = f'''
    <style>
    .stApp {{
        background-image: url("data:image/png;base64,{bin_str}");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
    }}
    
    /* This makes the content area slightly readable over the image */
    .main {{
        background-color: rgba(255, 255, 255, 0.85); 
        padding: 2rem;
        border-radius: 10px;
    }}
    </style>
    '''
    st.markdown(page_bg_img, unsafe_allow_html=True)

# Call the function with your image filename
try:
    set_png_as_page_bg('background.png')
except FileNotFoundError:
    st.warning("Background image not found. Please upload 'background.png' to GitHub.")

# --- 2. APP INTERFACE ---
st.title("üìç Kaduna Health Decision Support System")

st.sidebar.header("üìÇ 1. Upload Input Data")
# Standard inputs
outpatient_file = st.sidebar.file_uploader("Outpatient Excel", type=['xlsx'])
health_facilities = st.sidebar.file_uploader("Health Facilities (Zip)", type=['zip'])
lga_boundary = st.sidebar.file_uploader("LGA Boundaries (Zip)", type=['zip'])
roads = st.sidebar.file_uploader("Road Network (Geopackage)", type=['gpkg'])

# NEW: Population Raster Input
pop_raster = st.sidebar.file_uploader("Population Density (TIF)", type=['tif'])

st.sidebar.markdown("---")

# --- 3. ENGINE TRIGGER ---
if st.sidebar.button("üöÄ Run Full System Analysis"):
    # Updated check to ensure all five files are present
    if outpatient_file and health_facilities and lga_boundary and roads and pop_raster:
        with st.spinner("Analyzing spatial patterns and population density..."):
            # Load spatial data
            facilities_gdf = gpd.read_file(health_facilities)
            lga_gdf = gpd.read_file(lga_boundary)
            roads_gdf = gpd.read_file(roads)

            # 1. Run main analysis to generate the healthcare_deserts object
            # Included pop_raster in the arguments
            healthcare_deserts, results = run_analysis(
                facilities_gdf, 
                roads_gdf, 
                lga_gdf, 
                outpatient_file, 
                pop_raster
            )

            # 2. Generate priority recommendations
            priority_df, sites = calculate_priority_recommendations(lga_gdf, healthcare_deserts)

        # --- PHASE 4: OUTPUT DASHBOARD ---
        st.header("üìä Strategic Resource Allocation")
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.subheader("I. LGA Priority Ranking")
            st.dataframe(priority_df, use_container_width=True)
            
        with col2:
            st.subheader("II. Suggested GPS Locations")
            st.info("Proposed locations for new primary healthcare centers.")
            st.table(pd.DataFrame(sites))
    else:
        st.sidebar.error("‚ö†Ô∏è Please upload all required files, including the Population TIF.")

# --- FOOTER ---
st.markdown("---")
st.caption("Kaduna State Ministry of Health - Strategic Planning Division")
