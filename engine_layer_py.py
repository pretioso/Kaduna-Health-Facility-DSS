# -*- coding: utf-8 -*-
"""ENGINE LAYER.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1De_KA-dUY99JvldrYVRZibPQ9V7gdONe
"""

import streamlit as st
import geopandas as gpd
import pandas as pd
import numpy as np
import re
from rasterstats import zonal_stats
import tempfile
import os
from esda.moran import Moran
import libpysal as lp

def run_analysis(facilities_df, roads_df, lga_boundary, outpatient_files, population_tif):
    try:
        # --- 1. POPULATION EXTRACTION (Notebook Cell 3, 37) ---
        with tempfile.NamedTemporaryFile(suffix='.tif', delete=False) as tmp:
            tmp.write(population_tif.read())
            tmp_path = tmp.name
        
        stats = zonal_stats(lga_boundary, tmp_path, stats=["sum"])
        lga_boundary["Population"] = [s["sum"] if s and s["sum"] else 1 for s in stats]
        os.unlink(tmp_path)

        # --- 2. OUTPATIENT CLEANING (Notebook Cell 12, 46) ---
        all_data = []
        for file in outpatient_files:
            df = pd.read_excel(file)
            if 'Year' not in df.columns:
                match = re.search(r'(\d{4})', file.name)
                df['Year'] = int(match.group(1)) if match else 2024
            df["LGA"] = df["LGA"].str.replace("^kd\s+", "", regex=True).str.strip().str.upper()
            all_data.append(df)
        
        merged_df = pd.concat(all_data, ignore_index=True)
        st.session_state['long_data'] = merged_df # Store for trends
        
        # Calculate Rates for latest year
        latest = merged_df[merged_df['Year'] == merged_df['Year'].max()]
        # Sum all month columns
        val_cols = [c for c in latest.columns if c not in ['LGA', 'Year']]
        latest['Total'] = latest[val_cols].sum(axis=1)
        
        # --- 3. SPATIAL JOIN & MORAN'S I (Notebook Cell 61, 87) ---
        lga_boundary["NAME_2_UP"] = lga_boundary["NAME_2"].str.upper()
        spatial_data = lga_boundary.merge(latest[['LGA', 'Total']], left_on='NAME_2_UP', right_on='LGA', how='left')
        spatial_data['Rate'] = (spatial_data['Total'] / spatial_data['Population']) * 1000
        
        # Moran's I
        w = lp.weights.Queen.from_dataframe(spatial_data.fillna(0))
        st.session_state['moran'] = Moran(spatial_data['Rate'].fillna(0), w)

        # --- 4. DESERTS (Notebook Cell 135) ---
        fac_metric = facilities_df.to_crs(epsg=32632)
        coverage = fac_metric.buffer(30000).union_all() # 30km coverage
        deserts = gpd.overlay(lga_boundary.to_crs(epsg=32632), gpd.GeoDataFrame(geometry=[coverage], crs=32632), how='difference')

        return deserts, spatial_data, "Analysis Complete"
    except Exception as e:
        st.error(f"Engine Failure: {e}")
        return None, None, str(e)
