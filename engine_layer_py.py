# -*- coding: utf-8 -*-
"""ENGINE LAYER.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1De_KA-dUY99JvldrYVRZibPQ9V7gdONe
"""

import streamlit as st
import matplotlib.pyplot as plt
import seaborn as sns
import geopandas as gpd
import pandas as pd
import numpy as np
import networkx as nx
from sklearn.neighbors import BallTree
from shapely.geometry import Point, MultiPoint
from matplotlib.lines import Line2D
from pysal.explore import esda
from libpysal import weights
from esda.moran import Moran

# --- ALL LOGIC MUST BE INSIDE FUNCTIONS ---

def run_analysis(facilities_gdf, roads_gdf, lga_gdf, outpatient_file):
    """
    Main Engine: Processes data and returns healthcare_deserts for prioritization.
    """
    # 1. Process Outpatient Data
    merged_data = pd.read_excel(outpatient_file)
    
    long_data = merged_data.melt(id_vars=["LGA", 'Year'], var_name='Month', value_name='Outpatient_Count')
    long_data["LGA"] = long_data["LGA"].str.replace("^kd\s+", "", regex=True).str.strip()
    
    # 2. Isochrone / Accessibility Logic
    roads = roads_gdf.to_crs(epsg=32632)
    facilities = facilities_gdf.to_crs(epsg=32632)
    lga_boundary = lga_gdf.to_crs(epsg=32632)
    
    # [Simplified Logic for Speed]
    # In a real app, you would include your full 'create_isochrones' logic here
    isochrones_60min = facilities.geometry.buffer(30000) # 30km buffer as proxy for 60min
    coverage_union = isochrones_60min.union_all()
    
    # Define Healthcare Deserts
    healthcare_deserts = gpd.overlay(
        lga_gdf.to_crs(epsg=4326), 
        gpd.GeoDataFrame(geometry=[coverage_union], crs=32632).to_crs(epsg=4326), 
        how='difference'
    )
    
    # IMPORTANT: Return the data so app.py can use it
    return healthcare_deserts, long_data

def calculate_priority_recommendations(LGA_Boundary, healthcare_deserts):
    """
    Logic: Performs spatial intersection and identifies top gap areas.
    """
    LGA_proj = LGA_Boundary.to_crs(epsg=32632)
    deserts_proj = healthcare_deserts.to_crs(epsg=32632)

    priority_data = []
    for _, lga in LGA_proj.iterrows():
        lga_gap = deserts_proj.clip(lga.geometry)
        gap_area_km2 = lga_gap.area.sum() / 10**6

        status = "ðŸ”´ HIGH" if gap_area_km2 > 500 else "ðŸŸ¡ MEDIUM" if gap_area_km2 > 150 else "ðŸŸ¢ LOW"
        priority_data.append({
            "LGA Name": lga.get('NAME_2', 'Unknown'),
            "Underserved Area (kmÂ²)": round(gap_area_km2, 2),
            "Priority Status": status
        })

    priority_df = pd.DataFrame(priority_data).sort_values(by="Underserved Area (kmÂ²)", ascending=False)
    
    # Proposed Sites Logic
    deserts_exploded = healthcare_deserts.explode(index_parts=False)
    top_5_gaps = deserts_exploded.sort_values(by=deserts_exploded.area, ascending=False).head(5)
    
    proposed_sites = []
    for i, geom in enumerate(top_5_gaps.geometry):
        proposed_sites.append({
            "Site": f"Proposed PHC {i+1}",
            "Latitude": round(geom.centroid.y, 6),
            "Longitude": round(geom.centroid.x, 6)
        })

    return priority_df, proposed_sites
